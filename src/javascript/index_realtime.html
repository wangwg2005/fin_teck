<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
<script type="text/javascript" src="js/ml.js"></script>
<script type="text/javascript" src="js/common.js"></script>
<script type="text/javascript" src="js/echarts.min.js"></script> 
<script type="text/javascript" src="js/data/index_range.js"></script>
<script type="text/javascript">

var price={};
var data={};
var mm ={}

function compute(sid){
	var m5 = price[sid]["data"][sid]['m5'];
	mm[sid]=m5
	let ind = 800 -1;
	let p_close = m5[ind][2];
	
	var range = index_range[sid.substr(2)];
	//check_sid(sid,p_close);
	check(p_close,range.obs_ci_upper,range.obs_ci_lower,sid,"leverage model");
	
}

function jQuery18308958543031269126_1647150479422(data){
	let ps = data.data.diff;
	for(let p of ps){
		let code = p.f12;
		let prefix = 'sh';
		if (code.substr(0,1)=='3'){
			prefix = 'sz';
		}
		let sid = prefix + code;
		let current_price = p.f2/100
		<!-- check_sid(sid,current_price); -->
		let range= index_range[code];
		check(current_price,range.obs_ci_upper,range.obs_ci_lower,sid,"leverage model");
		
	}

}


function check_sid(sid,current_price){
	p5 = data[sid+'_5'] ;
	p10 = data[sid+'_10'];
	
	let ind = 800 -1;
	
	check(current_price,p5['upper'][ind],p5['lower'][ind],sid,"5 days");
	check(current_price,p10['upper'][ind],p10['lower'][ind],sid,"10 days");
	
}

function check(current_price, up_limit, buttom_limit,sid, line_name){
	console.log(`checking prices for ${sid}, current:${current_price}, upper:${up_limit}, lower:${buttom_limit}`);
	if(current_price>up_limit){
		notify(sid,sid+" breach the up limit of "+line_name);
	}else if(current_price<buttom_limit){
		notify(sid,sid+" breach the buttom limit of "+line_name);
	}
}



function init(){

	url = `http://ifzq.gtimg.cn/appstock/app/kline/mkline?param=sh000300,m5,,800&_var=price.sh000300`;
	load_js(url,function(){compute("sh000300");draw('diagram',"sh000300")});

	var sids=['sh000016','sh000905','sh000688'];
	<!-- var sids=['sh000016']; -->
	for( let sid of sids){
		url = `http://ifzq.gtimg.cn/appstock/app/kline/mkline?param=${sid},m5,,800&_var=price.${sid}`;
		load_js(url,function(){compute(sid);});
	}
	
	
	

	
	var real_url = 'https://push2.eastmoney.com/api/qt/ulist.np/get?ut=13697a1cc677c8bfa9a496437bfef419&fields=f1,f2,f3,f4,f12,f13,f14&secids=1.000016,1.000905,1.000300&cb=jQuery18308958543031269126_1647150479422&_=1647150479801';
	setInterval(function(){load_js(real_url);}, 1000*60*5);
	
	
	
}


function draw(con_id,sid){

	var m5 = mm[sid];

	var dom = document.getElementById(con_id);
	var myChart = echarts.init(dom);
	var option = null;
	var upColor = '#ec0000';
	var upBorderColor = '#8A0000';
	var downColor = '#00da3c';
	var downBorderColor = '#008F28';
	var data0;


	var category_data = Array.from(m5,a => a[0])
	var kline_data = Array.from(m5 ,a => [a[1],a[2],a[4],a[3]]);

	option = {
	    title: {
	        text: sid,
	        left: 0
	    },
	    tooltip: {
	        trigger: 'axis',
	        axisPointer: {
	            type: 'cross'
	        }
	    },
	    legend: {
	        data: ['日K']
	    },
	    grid: {
	        left: '10%',
	        right: '10%',
	        bottom: '15%'
	    },
	    xAxis: {
	        type: 'category',
	        data: category_data,
	        scale: true,
	        boundaryGap: false,
	        axisLine: {onZero: false},
	        splitLine: {show: false},
	        splitNumber: 20,
	        min: 'dataMin',
	        max: 'dataMax'
	    },
	    yAxis: {
	        scale: true,
	        splitArea: {
	            show: true
	        }
	    },
	    dataZoom: [
	        {
	            type: 'inside',
	            start: 50,
	            end: 100
	        },
	        {
	            show: true,
	            type: 'slider',
	            top: '90%',
	            start: 50,
	            end: 100
	        }
	    ],
	    series: [
	        {
	            name: '日K',
	            type: 'candlestick',
	            data: kline_data,
	            itemStyle: {
	                color: upColor,
	                color0: downColor,
	                borderColor: upBorderColor,
	                borderColor0: downBorderColor
	            },
	            markPoint: {
	                label: {
	                    normal: {
	                        formatter: function (param) {
	                            return param != null ? param.value.toFixed(2) : '';
	                        }
	                    }
	                },
	                data: [
	                   
	                    {
	                        name: 'highest value',
	                        type: 'max',
	                        valueDim: 'highest'
	                    },
	                    {
	                        name: 'lowest value',
	                        type: 'min',
	                        valueDim: 'lowest'
	                    },
	                    {
	                        name: 'average value on close',
	                        type: 'average',
	                        valueDim: 'close'
	                    }
	                ],
	                tooltip: {
	                    formatter: function (param) {
	                    	console.log(param.data.coord);
	                        return param.name + '<br>' + (param.data.coord.toFixed(2) || '');
	                    }
	                }
	            },
	            markLine: {
	                symbol: ['abc', '123'],
	                data: [
	                    [
	                        {
	                            name: 'from lowest to highest',
	                            type: 'min',
	                            valueDim: 'lowest',
	                            symbol: 'circle',
	                            symbolSize: 10,
	                            label: {
	                                show: false
	                            },
	                            emphasis: {
	                                label: {
	                                    show: false
	                                }
	                            }
	                        },
	                        {
	                            type: 'max',
	                            valueDim: 'highest',
	                            symbol: 'circle',
	                            symbolSize: 10,
	                            label: {
	                                show: false
	                            },
	                            emphasis: {
	                                label: {
	                                    show: false
	                                }
	                            }
	                        }
	                    ],
	                    {yAxis:index_range[sid.substr(2)].obs_ci_lower},
			
	                ]
	            }
	        },
	        

	    ]
	};
	
	
	
	
	
	if (option && typeof option === "object") {
	    myChart.setOption(option, true);
	}

}

</script>


</head>
<body onload='init()'>




<select onchange="draw('diagram',this.value)">
	<option value ="sh000016">上证50</option>
  <option value ="sh000300" selected="selected">沪深300</option>
  <option value="sh000905">中证500</option>
  <option value="sh000688">科创50</option>

</select>
<br/>
<table>
<thead>


</table>

<br/>
<div id="diagram" style="height:500px;width:100%"></div>
</body>
</html>