<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Index Analysis</title>
<script type="text/javascript" src="js/analyze.js"></script>
<script type="text/javascript" src="js/ml.js"></script>
<script type="text/javascript" src="js/draw.js"></script>
<script type="text/javascript" src="js/common.js"></script>
<script type="text/javascript" src="js/echarts.min.js"></script>
<script type="text/javascript" src="js/data/index_range.js"></script>
<script type="text/javascript" src="js/jquery-easyui/jquery.min.js"></script>
<script type="text/javascript" src="js/jquery-easyui/jquery.easyui.min.js"></script>
<link rel="stylesheet" type="text/css" href="js/jquery-easyui/themes/default/easyui.css">
<script type="text/javascript">

var datas = {}

function analyze_data(customize){
	index_id = document.getElementById("index").value;
	data = datas[index_id.substr(2)];
	<!-- datas[data[0].substr(1)]=data -->
	if(customize ===true){
		let v = $("#train_slider").slider("getValues");
		console.log(v);
		var train_set = data.slice(v[0],v[1]);
	}else{
		var len = data.length;
		var train_length = document.getElementById("train").value;
		var train_set = data.slice(- parseInt(train_length));
		$("#train_slider").slider({
		showTip:true,
		min:0,
		max:len,
		tipFormatter:function(v){
			if (typeof v == 'number'){
				return data[v]["日期"].substr(0,10);
			}else{
				return v["日期"].substr(0,10);
			}
		},
		range:true,
		value:[len-750,len-1]
	
	});
	}
	
	var x = Array.from(train_set, a =>a.lev);
	<!-- var y = Array.from(train_set, a=> ( a["最高价"]+ a["最低价"])/2); -->
	var y = Array.from(train_set, a=> a.close);
	var model = linearRegression(y,x);
	
	var test_length = document.getElementById("test").value;
	var test_set = data.slice(- parseInt(test_length));
	var fitted = Array.from(test_set, a => a.lev*model.slope + model.intercept);
	var upper = Array.from(fitted, a => a + 2 * model.se);
	var lower = Array.from(fitted, a => a - 2 * model.se);
	var kline = Array.from(test_set, a => [ a["日期"].substr(0,10), a["开盘价"], a["close"], a["最高价"], a["最低价"],])
	
	draw_k_line_2("diagram",{"upper":upper,"lower":lower},index_id,kline)

	//draw_gradient_line(index_id,date,[stds],'Volatility of Close');
}

function load_data(ind){
	var opts = document.getElementById("index").options;
	console.log("ind:"+ind)
	if (ind>0){
		let last_sid = opts[ind-1].value.substr(2);		
		datas[last_sid] = index_value.data;
		console.log(opts[ind-1].value.substr(2)+" loaded")
		console.log(index_value.data[0]['股票代码']);
		long_term(last_sid,"d"+ind, last_sid);
	}
	
	if(ind==opts.length){
		draw_d2();
		return
	}
	
	var index_id = opts[ind].value.substr(2);

	load_js(`js/data/${index_id}.js`,function(){load_data(ind+1);});

}

function load_realtime_price(cb){
	var real_url = 'https://push2.eastmoney.com/api/qt/ulist.np/get?ut=13697a1cc677c8bfa9a496437bfef419&fields=f1,f2,f3,f4,f12,f13,f14&secids=1.000016,1.000905,1.000300,1.000688&cb=jQuery18308958543031269126_1647150479422&_=1647150479801';
	load_js(real_url,cb);
}


function init(){
	
	load_realtime_price(function(){load_data(0);});
	ref_int = setInterval(refresh_all, 1000*3);
}


var boundaries = {};

function long_term(sid,cid, title){

	let data = datas[sid];
	
	var labels = new Array();
	var upper = new Array();
	var lower = new Array();

	for(let i = 5;i<750;i++){
		labels.push(i);
		var train_set = data.slice(-i);
		
		var x = Array.from(train_set, a =>a.lev);
		var y = Array.from(train_set, a=> a.close);
		var lr = linearRegression(y,x);
		let v = lr['slope'] * x[i-1] + lr["intercept"];
		upper.push(v + 2*lr["se"]);
		lower.push (v - 2*lr["se"] );
	
	}
	boundaries[sid]= {"upper":upper, "lower":lower,"label":labels};
	
}




function index_change(){
	analyze_data();

	<!-- load_js(`js/data/${index_id.substr(2)}.js`,analyze_data); -->
}

var price = {};

function jQuery18308958543031269126_1647150479422(data){

	let ps = data.data.diff;
	for(let p of ps){
		let code = p.f12;
		<!-- let prefix = 'sh'; -->
		<!-- if (code.substr(0,1)=='3'){ -->
			<!-- prefix = 'sz'; -->
		<!-- } -->
		<!-- let sid = prefix + code; -->
		let current_price = p.f2/100;
		price[code] = current_price;
		
	}
	console.log(JSON.stringify(price));
}

function draw_d2(){

	for(let sid in price){
		let p = new Array(boundaries[sid].upper.length);
		p.fill(price[sid]);
		draw_gradient_line(sid,boundaries[sid].label,[p,boundaries[sid].upper,boundaries[sid].lower],sid);
	}

}

function refresh_all(){
	load_realtime_price(draw_d2);


}

</script>





</head>
<body onload='init()'>



<select id ="index">
	<option value ="sh000016">上证50</option>
  <option value ="sh000300" selected="selected">沪深300</option>
  <option value="sh000905">中证500</option>
  <option value="sh000688">科创板</option>

</select>

<label>Train Range</label>
<select id="train" >
	<option value ="22">last Month</option>
  <option value ="66" >last 3 Months</option>
  <option value="132">last 6 Month</option>
  <option value="250">last 1 Year</option>
  <option value="500">last 2 Years</option>
  <option value="750" selected="selected">last 3 Years</option>
  <option value="0">Whole Range</option>

</select>

<label>Test Range</label>
<select id="test" >
	<option value ="22">last Month</option>
  <option value ="66" >last 3 Months</option>
  <option value="132">last 6 Month</option>
  <option value="250">last 1 Year</option>
  <option value="500">last 2 Years</option>
  <option value="750" >last 3 Years</option>
  <option value="0" selected="selected">Whole Range</option>

</select>

<a href="#" class="easyui-linkbutton" iconCls="icon-search" onclick='index_change();'>Get</a>
<br/>
<br/>
<label value = "Train Range" style="margin:20px">Train Range </label>
<br/>
<br/>
<input id='train_slider' class="easyui-slider" style="width:400px" />
<a href="#" class="easyui-linkbutton" iconCls="icon-search" onclick='analyze_data(true);'>Customize</a>
<table>
<thead>


</table>

<br/>
<div id="diagram" style="height:500px;width:100%"></div>
<hr/>

<div id="000016" style="height:500px;width:100%"></div>
<div id="000300" style="height:500px;width:100%"></div>
<div id="000905" style="height:500px;width:100%"></div>
<div id="000688" style="height:500px;width:100%"></div>
</body>
</html>