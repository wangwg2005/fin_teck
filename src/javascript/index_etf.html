<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
<script type="text/javascript" src="js/ml.js"></script>
<script type="text/javascript" src="js/draw.js"></script>
<script type="text/javascript" src="js/common.js"></script>
<script type="text/javascript" src="js/echarts.min.js"></script> 
<script type="text/javascript">

var price={};
var data={};
var mm ={}

function compute(sid){
	console.log(price);
	var m5 = price[sid]["data"][sid]['m5'];
	mm[sid]=m5;

	let p5 = calculateValue(m5,5);
	let p10 = calculateValue(m5,10);

	data[sid+'_5'] = p5;
	data[sid+'_10'] = p10;
	
	//check 
		
	let ind = 800 -1;
	let p_close = m5[ind][2];
	
	//check_sid(sid,p_close);
	check_sid(sid,p_close);
	
	
}

function jQuery18308958543031269126_1647150479422(data){
	let ps = data.data.diff;
	for(let p of ps){
		let code = p.f12;
		let prefix = 'sh';
		if (code.substr(0,1)=='3'){
			prefix = 'sz';
		}
		let sid = prefix + code;
		let current_price = p.f2/100
		check_sid(sid,current_price);
		
	}

}

function check_sid(sid,current_price){
	p5 = data[sid+'_5'] ;
	p10 = data[sid+'_10'];
	
	let ind = 800 -1;
	
	check(current_price,p5['upper'][ind],p5['lower'][ind],sid,"5 days");
	check(current_price,p10['upper'][ind],p10['lower'][ind],sid,"10 days");
	
}

function check(current_price, up_limit, buttom_limit,sid, line_name){

	if(current_price>up_limit){
		notify(sid,sid+" breach the up limit of "+line_name);
	}else if(current_price<buttom_limit){
		notify(sid,sid+" breach the buttom limit of "+line_name);
	}
}



function init(){

	var sids=['sh000016','sh000300','sh000905','sz399006'];
	<!-- var sids=['sh000016']; -->
	for( let sid of sids){
		url = `http://ifzq.gtimg.cn/appstock/app/kline/mkline?param=${sid},m5,,800&_var=price.${sid}`;
		load_js(url,function(){compute(sid)});
	}
	var real_url = 'https://push2.eastmoney.com/api/qt/ulist.np/get?ut=13697a1cc677c8bfa9a496437bfef419&fields=f1,f2,f3,f4,f12,f13,f14&secids=1.000016,1.000905,1.000300,0.399006&cb=jQuery18308958543031269126_1647150479422&_=1647150479801';
	setInterval(function(){load_js(real_url);}, 1000*60*5);
}

</script>


</head>
<body onload='init()'>



<select onchange="draw_k_line('diagram',this.value)">
	<option value ="sh000016">上证50</option>
  <option value ="sh000300" selected="selected">沪深300</option>
  <option value="sh000905">中证500</option>
  <option value="sz399006">创业板</option>

</select>
<br/>
<table>
<thead>


</table>

<br/>
<div id="diagram" style="height:500px;width:100%"></div>
</body>
</html>