<html>

<head>
    <link rel="stylesheet" type="text/css" href="js/jquery-easyui/themes/default/easyui.css">
    <link rel="stylesheet" type="text/css" href="js/jquery-easyui/themes/icon.css">
    <script type="text/javascript" src="js/jquery-easyui/jquery.min.js"></script>
    <script type="text/javascript" src="js/jquery-easyui/jquery.easyui.min.js"></script>
	<script type="text/javascript" src="js/echarts.min.js"></script> 
	
	
	<script type="text/javascript">
		var today_str=new Date().toJSON().substr(0,10);
		var url_temp='js/data/report_date_type.js';
		var origin_records = null;
		
		function loadJS(url, callback ){
					
			var script = document.createElement('script');
			fn = callback || function(){};
			script.type = 'text/javascript';
			script.onload = fn;
			
			console.log("loading js from "+url);

			script.src = url;
			document.getElementsByTagName('head')[0].appendChild(script);

		}
		
		function filter(origin){
			var devi= parseFloat( document.getElementById('devi').value);
			var rsq= parseFloat( document.getElementById('rsq').value);
			var pr= parseFloat( document.getElementById('pr').value);
			var vr= parseFloat( document.getElementById('vr').value);
			var perc= parseFloat( document.getElementById('perc').value);
			return origin.filter( a => a.R_Squared>rsq && a.deviation< devi && a.percent< perc && a.volume_std_rate>vr && a.close_std_rate>pr);
		}
		
		function refresh(){
			records = filter(origin_records);
			$('#detail_tab').datagrid({data: records});
			
			//draw_k();
		}
		
		function extract(){
			var code = document.getElementById('code').value;
			$('#detail_tab').datagrid({data: [origin_records.find( r => r.code.indexOf(code)>-1)]});
		}
		
		function search_data(){
			current_date = date_transform($('#date').val());
		
			let url = url_temp.replace('date',current_date).replace('type',$('#model').val());
		
			let script = document.createElement('script');
			script.type = 'text/javascript';
			script.onload = function(){
				origin_records = records;
				
				refresh();

			}
			
			console.log("loading js from "+url);
			
			try{

				script.src = url;
				
				document.getElementsByTagName('head')[0].appendChild(script);
			}catch(err){
				alert("无数据");
			}
			
			
		}
		
		function compute_value(){
			let url = 'http://qt.gtimg.cn/q=';
			let sids = Array.from(records, rec => rec['code']);
			url = url + sids.join();
			
			let script = document.createElement('script');
			script.type = 'text/javascript';
			var prices=new Array();
			script.onload = function(){
				sids.forEach(function(item,index){
					eval('prices['+index+'] = v_'+item)
				});
				prices = Array.from(prices, x => x.split('~'))
				
				let last_close = prices.reduce((pre,current) =>pre + parseFloat(current[4]),0);
				let current_price = prices.reduce((pre,current) =>pre + parseFloat(current[3]),0);
				
				console.log('last close:' + last_close);
				console.log('current price:' + current_price);
			}
			
			console.log("loading js from "+url);

			script.src = url;
			document.getElementsByTagName('head')[0].appendChild(script);
		
		
		}
	
		function init(){
			
			$('#date').val(today_str);
			$('#model_date').val(today_str);
			$('#date1').val(today_str);
			load_model("d");
			//search_data();
			
		}
		
		 function myparser(s){
			var t = Date.parse(s);
			if (!isNaN(t)){
				return new Date(t);
			} else {
				return new Date();
			}
		}
	
		function num_format(val,rowData,rowIndex){
			if(val!=null)
				return val.toFixed(4);
		}
		
		 function myformatter(date){
            var y = date.getFullYear();
            var m = date.getMonth()+1;
            var d = date.getDate();
            str = y+'-'+(m<10?('0'+m):m)+'-'+(d<10?('0'+d):d);
			alert(str);
			return str;
        }
		
		function date_transform(date_str1){
			let arr = date_str1.split("/");
			return arr[2]+"-"+arr[0]+"-"+arr[1];
		}
		
		var datas = [];
		
		function reduce_price(a,b){
			let m = a.length;
			let n = a[0].length;
			
			for(let i =0;i<m;i++){
				for (let j =0;j<n; j++){
					a[i][j] += b[i][j];
					
				}
			}
			
			return a;
			
		}
		
		function draw(){
		
			datas.push(sdata["data"]);
			
			if (datas.length !=  records.length){
				return;
			}
			let date = []
			var prices = [];
			
			
			datas.forEach(function(item, index){
			
				for(let sid in item){
					let rows = item[sid]["m5"];
					if(index == 0){
						date = Array.from(rows, row => row[0])
					}
					let price = Array.from(rows, row => row.slice(1,5))
					
					prices.push(price);
				}
			});
			
			
			prices = Array.from(prices, price => Array.from(price, p =>Array.from(p, a =>parseFloat(a))));

			nprice = prices.reduce(reduce_price);
			
			for (let i =0;i<nprice.length;i++){
				let price =nprice[i];
				let t =price[2];
				price[2] = price[3];
				price[3]= t;
			
			}
			
			var chartDom = document.getElementById('container');
			var myChart = echarts.init(chartDom);
			var option;
			
			option = {
			  xAxis: {
				data: date
			  },
			  yAxis: {	
				scale: true,
				splitArea: {
					show: true
			  }},
 	  	    tooltip: {
				trigger: 'axis',
				axisPointer: {
					type: 'cross'
				}
			},
			  series: [
				{
				  type: 'candlestick',
				//  dimensions:['open',"close","highest","lowest"],
				  data: nprice
				}
			  ]
			};
			
			if (option && typeof option === 'object') {
				myChart.setOption(option);
			}
		
		}
		
		var sids=[];
		function draw_k(){			
			sids = Array.from(records, a=>a["code"]);
			sids.forEach(function (item, index){
				url='http://ifzq.gtimg.cn/appstock/app/kline/mkline?param=sh000905,m5,,100&_var=sdata';
				rurl = url.replace("sh000905",item);
				loadJS(rurl, function(){draw();});
			} );
			
		}
		
		
		function candidate(){
			var date1 = date_transform($('#date1').val());
			
			var url = `js/data/c_sids_${date1}.js`;
			loadJS(url,candidate_filter)
		
		}
		
		function candidate_filter(){
			console.log(mc_sids);
			records = origin_records.filter(a => mc_sids.indexOf( a.code.substring(2))>-1 );

			$('#detail_tab').datagrid({data: records});
			draw_k();
		
		}
		
		function codeFmt(code,row,index){
			var sname = row.code;
			if ("sname" in row){
				sname = row.sname;
			}
			return `<a id="${code}" href="https://quote.eastmoney.com/${code}.html" target="_blank">${sname}</a>`;
		}
		
		function find_row(code){
			var code_con = document.getElementById('code');
			code_con.value=code;
			extract();
			code_con.focus();
		}
		
		function row_link_fmt(code){
			return `<a href="javascript:void(0)" onclick="find_row('${code}')">${code}</a>`;
		
		}
		
		var model_data={};
		
		
		function show_model(mname){
			var data=model_data[mname];
			var keys = Object.keys(data);
			var item0 = data[keys[0]];
			var cnames = Object.keys(item0);
			var columns = Array.from(cnames, cname =>{ return {field:cname,title:cname,sortable:true};});
			columns[cnames.length-1]['formatter']=row_link_fmt;
			console.log(columns);
			var rows = Object.values(data);
			$('#model_table').datagrid({title:"Model Data",remoteSort:false,columns: [columns],data: rows,toolbar:'#tb1'});
			
		}
		
		function load_model(mname){
			var url = `js/data/${mname}_data_${today_str}.js`;
			loadJS(url,function(){show_model(mname)});
		
		}
		
		
		

		
		
	
	
	
	
	
	</script>
	
	
	
	
</head>

	<div id='tb'>
		Date
		<input class="easyui-datebox" id='date' style="width:110px">
		Model: 
        <select id='model' class="easyui-combobox" panelHeight="auto" style="width:100px">
			<option value="lev">lev</option>
            <option value="mv">mv</option>
			<option value="comp">comp</option> 
        </select>
		
		<a href="#" class="easyui-linkbutton" iconCls="icon-search" onclick='search_data();'>Search</a>
		<br/>
		Date
		<input class="easyui-datebox" id='date1' style="width:110px">
		
		<a href="#" class="easyui-linkbutton" iconCls="icon-search" onclick='candidate();'>Candidates</a>
		<a href="#" class="easyui-linkbutton" iconCls="icon-search" onclick='refresh();'>Reset</a>
		<br/>
		R Squared
		<input id='rsq' name='rsq' value='0.8'/>
		
		Percent
		<input id='perc' name='perc' value='0'/>
		
		Devication
		<input id='devi' name='devi' value='0'/>
		
		price rate
		<input id='pr' name='pr' value='0'/>
		
		volume rate
		<input id='vr' name='vr' value='0'/>
		
		<a href="#" class="easyui-linkbutton" iconCls="icon-search" onclick='refresh();'>Filter</a>
		
		<br/>
		
			Stock Code
		<input id='code' name='code' value=''/>
		
		<a href="#" class="easyui-linkbutton" iconCls="icon-search" onclick='extract();'>Get</a>
		

	
	</div>
	
	
	<div id='tb1'>
		Date
		<input class="easyui-datebox" id='model_date' style="width:110px">
		Model: 
        <select id='model_ext_name' class="easyui-combobox" panelHeight="auto" style="width:100px">
			<option value="d">d</option>
        </select>
		
		<a href="#" class="easyui-linkbutton" iconCls="icon-search" onclick='search_data();'>Explore</a>

	
	</div>

	<body onload='init();'>
  <table id='detail_tab' class="easyui-datagrid" title="Detail" style="width:95%;height:600px,margin:5%;min-height:300px"
            data-options="singleSelect:true,remoteSort:false,collapsible:true,method:'get',fitColumns:true,toolbar:'#tb'">
        <thead>
            <tr>
                <th data-options="field:'code',width:120,formatter:codeFmt">code</th>
                <th data-options="field:'R_Squared',width:120,formatter:num_format,sortable:true,sorter:function(a,b){ return a-b; }  ">R_Squared</th>
                <th data-options="field:'F_Value',width:120,align:'right',formatter:num_format">F_Value</th>
                <th data-options="field:'F_P_value',width:120,align:'right',formatter:num_format">F_P_value</th>
                <th data-options="field:'Last Resid',width:130,formatter:num_format">Last Resid</th>
                <th data-options="field:'Last Fitted Value',width:120,align:'center',formatter:num_format">Last Fitted Value</th>
				<th data-options="field:'percent',width:120,sortable:true,formatter:num_format">percent</th>
				<th data-options="field:'deviation',width:120,sortable:true,formatter:num_format">deviation</th>
				<th data-options="field:'close_std_rate',sortable:true,width:120">price rate</th>
				<th data-options="field:'volume_std_rate',sortable:true,width:120">volume rate</th>
				<th data-options="field:'lev_ratio_rate',sortable:true,width:120">Leverage rate</th>
				<th data-options="field:'industry',sortable:true,width:120">Industry</th>
				<th data-options="field:'lev',width:80">Leverage</th>
				<th data-options="field:'realtime',width:80">realtime</th>
            </tr>
        </thead>
    </table>
	

	<table id="model_table" style="width:88%; height:666px; margin:88px" >
	</table>
	
	<div id="container" style="height:400px;width:1000px"></div>


	</body>

</html>